name: Test Power BI updateFromGit

on:
  workflow_dispatch:  # Manuell auslösbar in GitHub UI

permissions:
  contents: read

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # wichtig für alle Branches

      - name: Fetch all branches
        run: git fetch --all

      - name: Get commit hashes
        id: get_hashes
        run: |
          set -e

          git rev-parse --verify origin/gf_reportings > /dev/null || {
            echo "❌ Branch 'gf_reportings' nicht gefunden!" && exit 1
          }

          git rev-parse --verify origin/demo_report_source > /dev/null || {
            echo "❌ Branch 'demo_report_source' nicht gefunden!" && exit 1
          }

          workspaceHead=$(git rev-parse origin/gf_reportings)
          remoteCommitHash=$(git rev-parse origin/demo_report_source)

          echo "✅ Workspace Head: $workspaceHead"
          echo "✅ Remote Commit Hash: $remoteCommitHash"

          echo "workspaceHead=$workspaceHead" >> $GITHUB_ENV
          echo "remoteCommitHash=$remoteCommitHash" >> $GITHUB_ENV

      - name: Show environment values
        run: |
          echo "🔎 Confirmed workspaceHead: $workspaceHead"
          echo "🔎 Confirmed remoteCommitHash: $remoteCommitHash"

      - name: Get Power BI Token
        id: get_token
        run: |
          response=$(curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=${{ secrets.PBI_CLIENT_ID }}&client_secret=${{ secrets.PBI_CLIENT_SECRET }}&scope=https://analysis.windows.net/powerbi/api/.default" \
            https://login.microsoftonline.com/${{ secrets.PBI_TENANT_ID }}/oauth2/v2.0/token)

          echo "ACCESS_TOKEN=$(echo $response | jq -r '.access_token')" >> $GITHUB_ENV

      - name: Verify Git credentials
        run: |
          curl -X GET "https://api.fabric.microsoft.com/v1/workspaces/${{ secrets.PBI_WORKSPACE_ID }}/git/myGitCredentials" \
            -H "Authorization: Bearer $ACCESS_TOKEN"

      - name: Trigger Power BI Git updateFromGit
        run: |
          echo "📤 Sende Request an Power BI..."
          curl -X POST "https://api.fabric.microsoft.com/v1/workspaces/${{ secrets.PBI_WORKSPACE_ID }}/git/updateFromGit" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"workspaceHead\": \"${workspaceHead}\",
              \"remoteCommitHash\": \"${remoteCommitHash}\",
              \"conflictResolution\": {
                \"conflictResolutionType\": \"Workspace\",
                \"conflictResolutionPolicy\": \"PreferRemote\"
              },
              \"options\": {
                \"allowOverrideItems\": true
              }
            }"
